{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <a href="/" style="color: inherit; text-decoration: none; margin-right: 10px;">←</a>
            Job Search Parameters
        </div>
    </div>

    <form method="POST" action="{{ url_for('save_job_config') }}" enctype="multipart/form-data">

        <!-- SECTION: Search Basics -->
        <h2 style="border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; margin-top: 20px;">1. Search
            basics</h2>

        <div class="form-group">
            <label class="form-label">Search Mode</label>
            <div class="checkbox-group">
                <label class="checkbox-card">
                    <span>Remote Jobs Only</span>
                    <input type="checkbox" name="remote" {% if config.remote %}checked{% endif %}>
                </label>
                <label class="checkbox-card">
                    <span>Target <10 Applicants</span>
                            <input type="checkbox" name="lessthanTenApplicants" {% if config.lessthanTenApplicants
                                %}checked{% endif %}>
                </label>
                <label class="checkbox-card">
                    <span>Resident Status (In Country)</span>
                    <input type="checkbox" name="residentStatus" {% if config.residentStatus %}checked{% endif %}>
                </label>
            </div>
        </div>

        <div class="form-group" style="max-width: 300px;">
            <label class="form-label">Distance from chosen location (miles)</label>
            <select name="distance" class="form-control">
                {% for d in [0, 5, 10, 25, 50, 100] %}
                <option value="{{ d }}" {% if config.distance==d %}selected{% endif %}>{{ d }} miles</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Degrees completed (select applicable)</label>
            <div class="checkbox-group">
                {% for degree in ["High School Diploma", "Bachelor's Degree", "Post Graduate Diploma", "Master's
                Degree",
                "MBA", "Executive MBA"] %}
                <label class="checkbox-card">
                    <span>{{ degree }}</span>
                    <input type="checkbox" name="degreeCompleted" value="{{ degree }}" {% if degree in
                        config.get('degreeCompleted', []) %}checked{% endif %}>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- SECTION: Filters -->
        <h2 style="border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; margin-top: 30px;">2. Job filters
        </h2>

        <div class="form-group">
            <label class="form-label">Date Posted (Select One)</label>
            <div class="radio-group">
                {% for label in ['all time', 'month', 'week', '24 hours'] %}
                <label class="radio-card {% if config.date[label] %}selected{% endif %}">
                    <input type="radio" name="date_filter" value="{{ label }}" {% if config.date[label] %}checked{%
                        endif %}>
                    <span>{{ label|title }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Experience level</label>
            <div class="checkbox-group">
                {% for level, active in config.experienceLevel.items() %}
                <label class="checkbox-card">
                    <span>{{ level|title }}</span>
                    <input type="checkbox" name="exp_level_{{ level }}" {% if active %}checked{% endif %}>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Job type</label>
            <div class="checkbox-group">
                {% for type, active in config.jobTypes.items() %}
                <label class="checkbox-card">
                    <span>{{ type|title }}</span>
                    <input type="checkbox" name="job_type_{{ type }}" {% if active %}checked{% endif %}>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- SECTION: Keywords -->
        <h2 style="border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; margin-top: 30px;">3. Keywords
        </h2>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label class="form-label">Positions (one per line)</label>
                <textarea name="positions" class="form-control" rows="10">{{ config.positions|join('\n') }}</textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Locations (one per line)</label>
                <textarea name="locations" class="form-control" rows="10">{{ config.locations|join('\n') }}</textarea>
            </div>
        </div>

        <!-- SECTION: Blacklists -->
        <h2 style="border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; margin-top: 30px;">4. Blacklists
        </h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label class="form-label" placeholder="Organizations you don't want to work">Blacklisted companies
                    (optional)</label>
                <textarea name="companyBlacklist" class="form-control"
                    rows="5">{{ (config.companyBlacklist or [])|join('\n') }}</textarea>
            </div>
            <div class="form-group">
                <label class="form-label" placeholder="Jobs you won't want to apply for">Blacklisted titles
                    (optional)</label>
                <textarea name="titleBlacklist" class="form-control"
                    rows="5">{{ (config.titleBlacklist or [])|join('\n') }}</textarea>
            </div>
            <div class="form-group">
                <label class="form-label" placeholder="Some people you want to ignore...">Blacklisted posters
                    (optional)</label>
                <textarea name="posterBlacklist" class="form-control"
                    rows="5">{{ (config.posterBlacklist or [])|join('\n') }}</textarea>
            </div>
        </div>


        <!-- SECTION: Documents -->
        <h2 style="border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; margin-top: 30px;">5. Documents
        </h2>

        <div class="form-group">
            <label class="form-label">Resume (PDF only)</label>
            <div
                style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid var(--glass-border);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="file" id="resume_input" name="resume_file" accept=".pdf" class="form-control"
                        style="width: auto;">
                    <div style="flex: 1; font-size: 0.9em; color: var(--text-secondary);">
                        Current Path: <br>
                        <code style="color: var(--accent-color);">{{ config.uploads.resume }}</code>
                    </div>
                </div>

                <div id="file-status-msg" style="margin-top: 10px; font-weight: 500;">
                    {% if status and not status.valid_resume %}
                    <span style="color: var(--error-color);">⚠ File not found. Please upload a new one.</span>
                    {% else %}
                    <span style="color: var(--success-color);">✓ File found.</span>
                    {% endif %}
                </div>

                <button type="button" class="btn btn-primary" style="margin-top: 10px; font-size: 0.9em; display: none;"
                    id="upload-btn-visible">
                    Save Resume
                </button>
            </div>
            <script>
                document.getElementById('resume_input').addEventListener('change', function (e) {
                    const fileName = e.target.files[0]?.name;
                    const msgDiv = document.getElementById('file-status-msg');
                    const btn = document.getElementById('upload-btn-visible');

                    if (fileName) {
                        msgDiv.innerHTML = `<span style="color: var(--accent-color);">✓ Selected: <strong>${fileName}</strong></span>`;
                        btn.style.display = 'inline-block';
                        btn.textContent = 'Save Resume';
                        btn.disabled = false;
                    }
                });

                document.getElementById('upload-btn-visible').addEventListener('click', function () {
                    const fileInput = document.getElementById('resume_input');
                    if (!fileInput.files.length) return;

                    const btn = this;
                    btn.textContent = 'Saving...';
                    btn.disabled = true;

                    const formData = new FormData();
                    formData.append('resume_file', fileInput.files[0]);

                    fetch('/upload/resume', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                const msgDiv = document.getElementById('file-status-msg');
                                msgDiv.innerHTML = `<span style="color: var(--success-color);">✓ Resume saved successfully!</span>`;
                                btn.textContent = 'Saved';
                                setTimeout(() => {
                                    btn.style.display = 'none';
                                    btn.textContent = 'Save Resume';
                                    btn.disabled = false;
                                }, 2000);
                            } else {
                                alert('Error saving resume: ' + (data.message || 'Unknown error'));
                                btn.textContent = 'Save Resume';
                                btn.disabled = false;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error uploading file');
                            btn.textContent = 'Save Resume';
                            btn.disabled = false;
                        });
                });
            </script>
        </div>

        <!-- SECTION: Auto-Fill Answers -->
        <h2 style="border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; margin-top: 30px;">6. Auto-fill
            answers</h2>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label class="form-label">Minimum salary (annual)</label>
                <input type="number" name="salaryMinimum" value="{{ config.salaryMinimum }}" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">GPA</label>
                <input type="text" name="universityGpa" value="{{ config.universityGpa }}" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Notice period (weeks)</label>
                <input type="number" name="noticePeriod" value="{{ config.noticePeriod }}" class="form-control">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Standard questions (Yes/No type)</label>
            <button type="button" class="btn btn-secondary" style="margin-bottom: 10px; font-size: 0.8em;"
                onclick="document.getElementById('chk-container').classList.toggle('hidden')">
                Toggle Questions
            </button>
            <div id="chk-container" class="checkbox-group hidden">
                <!-- Logic to split General vs Citizenship -->

                <h5>General</h5>
                {% for key, val in config.checkboxes.items() %}
                {% if 'citizen' not in key and (val is sameas true or val is sameas false) %}
                <label class="checkbox-card">
                    <span style="font-size: 0.9em;">{{ key|replace('driversLicence', "Driver's
                        License")|replace('requireVisa', 'Visa Required')|replace('legallyAuthorized', 'Legally
                        Authorized')|replace('certifiedProfessional', 'Certified Professional')|replace('urgentFill',
                        'Urgent Fill')|replace('commute', 'Commute')|replace('remote', 'Remote')|replace('drugTest',
                        'Drug Test')|replace('assessment', 'Assessment')|replace('backgroundCheck', 'Background
                        Check')|replace('hybrid', 'Hybrid')|title }}</span>
                    <input type="checkbox" name="chk_{{ key }}" {% if val %}checked{% endif %}>
                </label>
                {% endif %}
                {% endfor %}

                <h5 style="margin-top: 15px;">Citizenship status (select applicable)</h5>
                {% for key, val in config.checkboxes.items() %}
                {% if 'citizen' in key and (val is sameas true or val is sameas false) %}
                <label class="checkbox-card">
                    <!-- Ensure Exact Case Presentation -->
                    <span style="font-size: 0.9em;">{{ key }}</span>
                    <input type="checkbox" name="chk_{{ key }}" {% if val %}checked{% endif %}>
                </label>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Languages (Proficiency)</label>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                {% set lang_options = ['None', 'Conversational', 'Professional', 'Native or bilingual'] %}
                {% set target_langs = ['english', 'arabic', 'french', 'german', 'chinese', 'korean', 'japanese'] %}

                {% for lang in target_langs %}
                <div class="checkbox-card" style="display: block;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">{{ lang|title }}</label>
                    <select name="lang_{{ lang }}" class="form-control" style="padding: 6px;">
                        {% for opt in lang_options %}
                        {% set current_val = config.languages.get(lang, 'None') %}
                        <option value="{{ opt }}" {% if current_val|lower==opt|lower %}selected{% endif %}>
                            {{ opt }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>
        </div>

        <div style="display: flex; gap: 16px; margin-top: 40px; margin-bottom: 20px;">
            <a href="/" class="btn btn-secondary" style="flex: 1; justify-content: center;">Cancel</a>
            <button type="submit" class="btn btn-primary" style="flex: 1; justify-content: center;">Save
                Configuration</button>
        </div>

    </form>
</div>
{% endblock %}